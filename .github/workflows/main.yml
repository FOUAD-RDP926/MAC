name: macOS-WebVNC-Cloudflare

on:
  workflow_dispatch:

jobs:
  macos-web-access:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable macOS Screen Sharing
        run: |
          # تفعيل مشاركة الشاشة ووضع كلمة مرور للـ VNC
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvncpw -vncpw "vncpassword" \
          -restart -agent -privs -all

      - name: Install Cloudflared
        run: brew install cloudflared

      - name: Setup noVNC (Python & Git)
        run: |
          # تحميل noVNC مباشرة من المصدر
          git clone https://github.com/novnc/noVNC.git $HOME/noVNC
          git clone https://github.com/novnc/websockify $HOME/noVNC/utils/websockify
          
          # تثبيت متطلبات websockify باستخدام python
          pip3 install numpy

      - name: Start noVNC and Cloudflare Tunnel
        run: |
          # 1. تشغيل noVNC في الخلفية على بورت 6080
          # يربط بورت المتصفح (6080) ببورت الماك (5900)
          $HOME/noVNC/utils/novnc_proxy --vnc localhost:5900 --listen 6080 & 
          
          # 2. تشغيل نفق Cloudflare
          nohup cloudflared tunnel --url http://localhost:6080 > cloudflare.log 2>&1 &
          
          # الانتظار حتى يتولد الرابط
          sleep 15

      - name: Display Connection Info
        run: |
          # استخراج الرابط من ملف السجل
          CF_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' cloudflare.log | head -n 1)
          echo "=========================================="
          echo "Access your macOS via Browser here:"
          echo "$CF_URL/vnc.html?autoconnect=true"
          echo ""
          echo "VNC Password: vncpassword"
          echo "=========================================="
          
          # حفظ الرابط في البيئة للتأكد من بقائه
          echo "FINAL_URL=$CF_URL" >> $GITHUB_ENV

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] Runner is running... URL: ${{ env.FINAL_URL }}/vnc.html"
            sleep 300
          done
          
