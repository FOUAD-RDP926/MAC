name: macOS-VNC-AuthFix

on:
  workflow_dispatch:

jobs:
  macos-web-access:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Create User apple (Admin123)
        run: |
          # 1. إنشاء المستخدم وتعيينه مسؤول
          sudo sysadminctl -addUser "apple" -fullName "Apple User" -password "Admin123" -admin
          
      - name: Force VNC Permissions (The Fix)
        run: |
          # إيقاف الخدمة أولاً لضمان تطبيق الإعدادات
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart -deactivate -stop

          # إجبار النظام على قبول VNC Connections
          sudo defaults write /Library/Preferences/com.apple.RemoteManagement VNCAlwaysStartOnConsole -bool true
          
          # إعداد الصلاحيات للمستخدم apple + وضع كلمة مرور VNC
          # الأمر الحاسم هنا هو setvnclegacy -vnclegacy yes
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -users "apple" -privs -all \
          -clientopts -setvncpw -vncpw "vncpassword" -setvnclegacy -vnclegacy yes \
          -restart -agent -mask 31

      - name: Install Tools
        run: |
          brew install cloudflared
          git clone https://github.com/novnc/noVNC.git $HOME/noVNC
          git clone https://github.com/novnc/websockify $HOME/noVNC/utils/websockify
          pip3 install numpy --break-system-packages

      - name: Start Services
        run: |
          # تشغيل noVNC على 127.0.0.1 لتجنب الرفض الخارجي
          nohup $HOME/noVNC/utils/novnc_proxy --vnc 127.0.0.1:5900 --listen 6080 &
          sleep 5
          
          # تشغيل Cloudflare Tunnel
          nohup cloudflared tunnel --url http://127.0.0.1:6080 > cloudflare.log 2>&1 &
          sleep 15

      - name: Get Info
        run: |
          CF_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' cloudflare.log | head -n 1)
          echo "=========================================="
          echo "LINK: $CF_URL/vnc.html?autoconnect=true"
          echo "VNC Pass: vncpassword"
          echo "Mac User: apple  |  Pass: Admin123"
          echo "=========================================="
          echo "URL=$CF_URL" >> $GITHUB_ENV

      - name: Keep Alive
        run: |
          while true; do
            echo "Running: ${{ env.URL }}"
            sleep 300
          done
