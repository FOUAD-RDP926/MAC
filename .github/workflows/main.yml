name: macOS-WebVNC-Cloudflare

on:
  workflow_dispatch:

jobs:
  macos-web-access:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
      - name: Enable macOS Screen Sharing
        run: |
          sudo launchctl load -w /System/Library/LaunchDaemons/com.apple.screensharing.plist
          # ضبط كلمة مرور للـ VNC (ضروري للاتصال الخارجي)
          sudo /System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart \
          -activate -configure -access -on \
          -clientopts -setvncpw -vncpw "vncpassword" \
          -restart -agent -privs -all

      - name: Install noVNC and Cloudflared
        run: |
          # تثبيت الأدوات اللازمة
          brew install novnc cloudflared
          
      - name: Start noVNC Proxy
        run: |
          # تشغيل websockify لتحويل VNC إلى Web Port (6080)
          # الماك يعمل افتراضياً على بورت 5900 للـ VNC
          nohup /usr/local/bin/websockify --web /usr/local/share/novnc 6080 localhost:5900 &
          sleep 5

      - name: Start Cloudflare Tunnel
        id: cloudflare
        run: |
          # تشغيل نفق Cloudflare وتوجيهه لبورت noVNC
          nohup cloudflared tunnel --url http://localhost:6080 > cloudflare.log 2>&1 &
          sleep 10
          # استخراج الرابط من ملف السجل
          CF_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' cloudflare.log | head -n 1)
          echo "WEB_URL=$CF_URL" >> $GITHUB_ENV

      - name: Display Connection Info
        run: |
          echo "=========================================="
          echo "Access your macOS via Browser here:"
          echo "${{ env.WEB_URL }}/vnc.html?autoconnect=true"
          echo ""
          echo "VNC Password: vncpassword"
          echo "=========================================="

      - name: Keep Alive
        run: |
          while true; do
            echo "[$(date)] Runner is running... Check the link above."
            sleep 300
          done
